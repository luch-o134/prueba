<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuestros Momentos üíï</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="album-container">
        <header class="album-header">
            <h1>üíï Nuestros Momentos Especiales üíï</h1>
            <p>Un √°lbum lleno de amor y recuerdos incre√≠bles</p>
            <div class="sync-status" id="syncStatus">üîÑ Conectando...</div>
        </header>

        <div class="album-grid">
            <!-- Foto 1 -->
            <div class="photo-frame">
                <div class="photo-placeholder" onclick="addPhoto(this)">
                    <div class="placeholder-content">
                        <span class="add-icon">üì∑</span>
                        <span class="placeholder-text">Nuestra primera foto juntos</span>
                    </div>
                    <img class="photo-img" style="display: none;" alt="Foto 1">
                </div>
                <div class="photo-caption">
                    <input type="text" placeholder="Escribe una dedicatoria..." class="caption-input">
                </div>
            </div>

            <!-- Foto 2 -->
            <div class="photo-frame">
                <div class="photo-placeholder" onclick="addPhoto(this)">
                    <div class="placeholder-content">
                        <span class="add-icon">üíë</span>
                        <span class="placeholder-text">Nuestra primera cita</span>
                    </div>
                    <img class="photo-img" style="display: none;" alt="Foto 2">
                </div>
                <div class="photo-caption">
                    <input type="text" placeholder="Escribe una dedicatoria..." class="caption-input">
                </div>
            </div>

            <!-- Foto 3 -->
            <div class="photo-frame">
                <div class="photo-placeholder" onclick="addPhoto(this)">
                    <div class="placeholder-content">
                        <span class="add-icon">üåπ</span>
                        <span class="placeholder-text">Un momento especial</span>
                    </div>
                    <img class="photo-img" style="display: none;" alt="Foto 3">
                </div>
                <div class="photo-caption">
                    <input type="text" placeholder="Escribe una dedicatoria..." class="caption-input">
                </div>
            </div>

            <!-- Foto 4 -->
            <div class="photo-frame">
                <div class="photo-placeholder" onclick="addPhoto(this)">
                    <div class="placeholder-content">
                        <span class="add-icon">üéâ</span>
                        <span class="placeholder-text">Celebrando juntos</span>
                    </div>
                    <img class="photo-img" style="display: none;" alt="Foto 4">
                </div>
                <div class="photo-caption">
                    <input type="text" placeholder="Escribe una dedicatoria..." class="caption-input">
                </div>
            </div>

            <!-- Foto 5 -->
            <div class="photo-frame">
                <div class="photo-placeholder" onclick="addPhoto(this)">
                    <div class="placeholder-content">
                        <span class="add-icon">üåÖ</span>
                        <span class="placeholder-text">Un atardecer contigo</span>
                    </div>
                    <img class="photo-img" style="display: none;" alt="Foto 5">
                </div>
                <div class="photo-caption">
                    <input type="text" placeholder="Escribe una dedicatoria..." class="caption-input">
                </div>
            </div>

            <!-- Foto 6 -->
            <div class="photo-frame">
                <div class="photo-placeholder" onclick="addPhoto(this)">
                    <div class="placeholder-content">
                        <span class="add-icon">üèñÔ∏è</span>
                        <span class="placeholder-text">Aventura en la playa</span>
                    </div>
                    <img class="photo-img" style="display: none;" alt="Foto 6">
                </div>
                <div class="photo-caption">
                    <input type="text" placeholder="Escribe una dedicatoria..." class="caption-input">
                </div>
            </div>

            <!-- Foto 7 -->
            <div class="photo-frame">
                <div class="photo-placeholder" onclick="addPhoto(this)">
                    <div class="placeholder-content">
                        <span class="add-icon">üçï</span>
                        <span class="placeholder-text">Cena rom√°ntica</span>
                    </div>
                    <img class="photo-img" style="display: none;" alt="Foto 7">
                </div>
                <div class="photo-caption">
                    <input type="text" placeholder="Escribe una dedicatoria..." class="caption-input">
                </div>
            </div>

            <!-- Foto 8 -->
            <div class="photo-frame">
                <div class="photo-placeholder" onclick="addPhoto(this)">
                    <div class="placeholder-content">
                        <span class="add-icon">üéà</span>
                        <span class="placeholder-text">Tu cumplea√±os</span>
                    </div>
                    <img class="photo-img" style="display: none;" alt="Foto 8">
                </div>
                <div class="photo-caption">
                    <input type="text" placeholder="Escribe una dedicatoria..." class="caption-input">
                </div>
            </div>

            <!-- Foto 9 -->
            <div class="photo-frame">
                <div class="photo-placeholder" onclick="addPhoto(this)">
                    <div class="placeholder-content">
                        <span class="add-icon">üåô</span>
                        <span class="placeholder-text">Una noche perfecta</span>
                    </div>
                    <img class="photo-img" style="display: none;" alt="Foto 9">
                </div>
                <div class="photo-caption">
                    <input type="text" placeholder="Escribe una dedicatoria..." class="caption-input">
                </div>
            </div>

            <!-- A√±adir m√°s fotos -->
            <div class="add-more-frame" onclick="addNewFrame()">
                <div class="add-more-content">
                    <span class="add-icon">‚ûï</span>
                    <span class="add-text">Agregar m√°s fotos</span>
                </div>
            </div>
        </div>

        <div class="love-message">
            <h2>üíå Mensaje especial para ti</h2>
            <textarea id="loveNote" placeholder="Escribe aqu√≠ un mensaje de amor para tu pareja..."></textarea>
            <button onclick="saveLoveNote()" class="save-btn">üíæ Guardar mensaje</button>
        </div>
    </div>

    <!-- Input oculto para subir archivos -->
    <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD7qiFPnoCuXLpn4f8xyjEG-BvYF5Xcd7I",
            authDomain: "amor-6dacb.firebaseapp.com",
            databaseURL: "https://amor-6dacb-default-rtdb.firebaseio.com",
            projectId: "amor-6dacb",
            storageBucket: "amor-6dacb.firebasestorage.app",
            messagingSenderId: "434396439759",
            appId: "1:434396439759:web:5e404796c313f0bac4c3ba",
            measurementId: "G-JEQ9FJP8FS"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const storage = getStorage(app);
        
        // Hacer disponible globalmente
        window.db = database;
        window.storage = storage;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbGet = get;
        window.storageRef = storageRef;
        window.uploadBytes = uploadBytes;
        window.getDownloadURL = getDownloadURL;
        window.onValue = onValue;

        // Actualizar estado de conexi√≥n
        document.getElementById('syncStatus').innerHTML = '‚úÖ Conectado';
        console.log('Firebase inicializado correctamente');
    </script>

    <script>
        let currentPhotoFrame = null;
        const ALBUM_ID = 'nuestro_album'; // ID fijo para que ambos accedan al mismo √°lbum

        function updateSyncStatus(message, isError = false) {
            const status = document.getElementById('syncStatus');
            status.innerHTML = message;
            status.style.color = isError ? '#ff6b6b' : '#4ecdc4';
        }

        function addPhoto(element) {
            currentPhotoFrame = element;
            document.getElementById('fileInput').click();
        }

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && currentPhotoFrame) {
                try {
                    updateSyncStatus('üì§ Subiendo foto...');
                    
                    // Subir imagen a Firebase Storage
                    const timestamp = Date.now();
                    const imageRef = window.storageRef(window.storage, `photos/${ALBUM_ID}/${timestamp}_${file.name}`);
                    const snapshot = await window.uploadBytes(imageRef, file);
                    const downloadURL = await window.getDownloadURL(snapshot.ref);
                    
                    // Mostrar imagen
                    const img = currentPhotoFrame.querySelector('.photo-img');
                    const placeholder = currentPhotoFrame.querySelector('.placeholder-content');
                    
                    img.src = downloadURL;
                    img.style.display = 'block';
                    placeholder.style.display = 'none';
                    
                    // Guardar en Firebase Database
                    const frameIndex = Array.from(document.querySelectorAll('.photo-frame')).indexOf(currentPhotoFrame.parentElement);
                    await window.dbSet(window.dbRef(window.db, `albums/${ALBUM_ID}/photos/${frameIndex}`), downloadURL);
                    
                    updateSyncStatus('üíï Foto guardada!');
                    createHearts(currentPhotoFrame);
                    
                    setTimeout(() => {
                        updateSyncStatus('‚úÖ Sincronizado');
                    }, 2000);
                    
                } catch (error) {
                    console.error('Error al subir la foto:', error);
                    updateSyncStatus('‚ùå Error al subir', true);
                    alert('Error al subir la foto. Verifica tu conexi√≥n.');
                }
            }
        }

        function addNewFrame() {
            const albumGrid = document.querySelector('.album-grid');
            const addMoreFrame = document.querySelector('.add-more-frame');
            
            const newFrame = document.createElement('div');
            newFrame.className = 'photo-frame';
            newFrame.innerHTML = `
                <div class="photo-placeholder" onclick="addPhoto(this)">
                    <div class="placeholder-content">
                        <span class="add-icon">üíï</span>
                        <span class="placeholder-text">Nuevo recuerdo</span>
                    </div>
                    <img class="photo-img" style="display: none;" alt="Nueva foto">
                </div>
                <div class="photo-caption">
                    <input type="text" placeholder="Escribe una dedicatoria..." class="caption-input">
                </div>
            `;
            
            albumGrid.insertBefore(newFrame, addMoreFrame);
            
            // Animaci√≥n de entrada
            newFrame.style.opacity = '0';
            newFrame.style.transform = 'scale(0.8)';
            setTimeout(() => {
                newFrame.style.transition = 'all 0.5s ease';
                newFrame.style.opacity = '1';
                newFrame.style.transform = 'scale(1)';
            }, 100);
        }

        async function saveLoveNote() {
            const note = document.getElementById('loveNote').value;
            if (note.trim()) {
                try {
                    updateSyncStatus('üíå Guardando mensaje...');
                    await window.dbSet(window.dbRef(window.db, `albums/${ALBUM_ID}/loveNote`), note);
                    updateSyncStatus('üíï Mensaje guardado!');
                    createHearts(document.querySelector('.love-message'));
                    
                    setTimeout(() => {
                        updateSyncStatus('‚úÖ Sincronizado');
                    }, 2000);
                } catch (error) {
                    console.error('Error al guardar mensaje:', error);
                    updateSyncStatus('‚ùå Error al guardar', true);
                }
            }
        }

        function createHearts(element) {
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const heart = document.createElement('div');
                    heart.innerHTML = 'üíï';
                    heart.className = 'floating-heart';
                    heart.style.position = 'absolute';
                    heart.style.left = Math.random() * 100 + '%';
                    heart.style.fontSize = '20px';
                    heart.style.pointerEvents = 'none';
                    heart.style.zIndex = '1000';
                    
                    element.style.position = 'relative';
                    element.appendChild(heart);
                    
                    heart.animate([
                        { transform: 'translateY(0px)', opacity: 1 },
                        { transform: 'translateY(-100px)', opacity: 0 }
                    ], {
                        duration: 2000,
                        easing: 'ease-out'
                    });
                    
                    setTimeout(() => heart.remove(), 2000);
                }, i * 200);
            }
        }

        // Guardar dedicatorias en tiempo real
        document.addEventListener('input', async function(e) {
            if (e.target.classList.contains('caption-input')) {
                const frameIndex = Array.from(document.querySelectorAll('.caption-input')).indexOf(e.target);
                try {
                    await window.dbSet(window.dbRef(window.db, `albums/${ALBUM_ID}/captions/${frameIndex}`), e.target.value);
                } catch (error) {
                    console.error('Error al guardar dedicatoria:', error);
                }
            }
        });

        // Cargar datos al inicio y escuchar cambios en tiempo real
        window.addEventListener('load', async function() {
            try {
                updateSyncStatus('üîÑ Cargando √°lbum...');

                // Escuchar cambios en tiempo real
                window.onValue(window.dbRef(window.db, `albums/${ALBUM_ID}`), (snapshot) => {
                    if (snapshot.exists()) {
                        const albumData = snapshot.val();
                        
                        // Cargar fotos
                        if (albumData.photos) {
                            Object.keys(albumData.photos).forEach(index => {
                                const frame = document.querySelectorAll('.photo-frame')[parseInt(index)];
                                if (frame) {
                                    const img = frame.querySelector('.photo-img');
                                    const placeholder = frame.querySelector('.placeholder-content');
                                    if (img.src !== albumData.photos[index]) {
                                        img.src = albumData.photos[index];
                                        img.style.display = 'block';
                                        placeholder.style.display = 'none';
                                    }
                                }
                            });
                        }

                        // Cargar dedicatorias
                        if (albumData.captions) {
                            Object.keys(albumData.captions).forEach(index => {
                                const input = document.querySelectorAll('.caption-input')[parseInt(index)];
                                if (input && input.value !== albumData.captions[index]) {
                                    input.value = albumData.captions[index];
                                }
                            });
                        }

                        // Cargar mensaje de amor
                        if (albumData.loveNote) {
                            const loveNoteTextarea = document.getElementById('loveNote');
                            if (loveNoteTextarea.value !== albumData.loveNote) {
                                loveNoteTextarea.value = albumData.loveNote;
                            }
                        }
                    }
                    updateSyncStatus('‚úÖ Sincronizado');
                });

            } catch (error) {
                console.error('Error al cargar datos:', error);
                updateSyncStatus('‚ùå Error de conexi√≥n', true);
            }
        });
    </script>
</body>
</html>